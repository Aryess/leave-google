// Generated by CoffeeScript 1.9.0
var async, googleToken, importCalendar, importContacts, importPhotos, log, realtimer;

googleToken = require('../utils/google_access_token');

importContacts = require('../utils/import_contacts');

importPhotos = require('../utils/import_photos');

importCalendar = require('../utils/import_calendar');

realtimer = require('../utils/realtimer');

async = require('async');

log = require('printit')('leaveGcontroller');

module.exports.index = function(req, res) {
  var url;
  url = googleToken.getAuthUrl();
  return res.render('index', {
    imports: "window.oauthUrl = \"" + url + "\";"
  });
};

module.exports.lg = function(req, res, next) {
  var auth_code, scope, _ref;
  res.send(200);
  _ref = req.body, auth_code = _ref.auth_code, scope = _ref.scope;
  return googleToken.generateRequestToken(auth_code, function(err, tokens) {
    if (err) {
      log.error(err);
    }
    if (!(tokens != null ? tokens.access_token : void 0)) {
      console.log("No access token");
      realtimer.sendEnd("invalid token");
      return;
    }
    return async.series([
      function(callback) {
        if (scope.photos !== 'true') {
          return callback(null);
        }
        return importPhotos(tokens.access_token, function(err) {
          if (err) {
            realtimer.sendPhotosErr(err);
          }
          realtimer.sendEnd("photos.end");
          return callback(null);
        });
      }, function(callback) {
        if (scope.calendars !== 'true') {
          return callback(null);
        }
        return importCalendar(tokens.access_token, function() {
          if (err) {
            realtimer.sendCalendarErr(err);
          }
          realtimer.sendEnd("events.end");
          return callback(null);
        });
      }, function(callback) {
        if (scope.contacts !== 'true') {
          return callback(null);
        }
        return importContacts(tokens.access_token, function(err) {
          if (err) {
            realtimer.sendContactsErr(err);
          }
          realtimer.sendEnd("contacts.end");
          return callback(null);
        });
      }
    ], function(err) {
      log.debug("leave google complete");
      realtimer.sendEnd("ok");
      if (err) {
        return console.log(err);
      }
    });
  });
};
